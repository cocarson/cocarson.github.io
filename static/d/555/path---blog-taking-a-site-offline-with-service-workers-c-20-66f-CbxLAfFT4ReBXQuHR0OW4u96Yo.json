{"data":{"markdownRemark":{"html":"<h2>Introduction</h2>\n<p>Service workers are a technology that have been emphasized by the web community for the past few years, along with terms like \"Progressive Web Apps\" and other futuristic technologies. To be honest, I was always put off by the name. It so jargon-y and technical that I figured it must be a fad that was better to let pass.</p>\n<p>Of course, this does not appear to be the case. Service workers are being implemented all over the web - from sites trying to provide seamless offline experiences to mega blogs interested in bombarding you with desktop push notifications, service workers have become an important part of the web.</p>\n<p>So what is a service worker? In its simplest form, a service worker is a JavaScript file that has access to a page's requests and responses. For some reason I figured a service worker had to be a lot more complex than that. But not really, service workers are just scripts that intercepts network requests.</p>\n<p>What is the value in a script that intercepts page requests? One of the core motivations for service workers is for providing better experiences when internet connection is lost. This is especially relevant for mobile devices where cellular connection could be lost at any time (or my home wifi network). In mobile apps, if you loose connection apps doesn't crash and burn, instead they often let you know about the connection loss and allows you to continue using the app with what ever data it has downloaded. When connection returns, the app doesn't require a full reboot (refresh), instead it automatically reconnects and immediately performs relevant network requests.</p>\n<p>The allure of service workers is their potential to allow web apps to exhibit similar functionality. This is especially necessary internationally where phone plans may be limited and users do not want to download entire apps to their restricted phone storage. Instead they can use the web app, without missing out on the benefits of a mobile application.</p>\n<h2>Getting Started</h2>\n<p>To start writing a service worker there are a few JavaScript prerequisites I recommend understanding:</p>\n<ol>\n<li>Event based programming</li>\n<li>Promises</li>\n</ol>\n<p>Service workers respond to events - the FetchEvent, InstallEvent, NotificationEvent, and SyncEvent to name a few. I would definitely recommend understanding JS event based programming and callbacks before learning to write a service worker.</p>\n<p>Writing Promises. While Promise logic is not always easy to follow, understanding the way they work is required for writing a service worker. Service work APIs rely heavily on Promises because they are intercepting every single request a site makes, so it is important the code is non-blocking.</p>\n<p>All that is left to begin writing a service worker is learning the related APIs and how they fit together. This requires a bit of memorization off the bat, but luckily there is great <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API\">documentation</a> for reference. (love you MDN)</p>\n<p>The service worker that we are going to write is relatively minimal. It should cache all of the requests related to a web page. This includes the HTML page and all of the assets loaded by that page.</p>\n<h3>Service Worker Lifecycle</h3>\n<p>Service worker files are loaded by the browser differently than normal HTML, CSS and JS files. Instead of being fetched and parsed on page load, service workers go through an install process, or \"lifecycle\". The service worker only works through its lifecycle when it is registered and when it is unregistered; otherwise the service worker is cached by the browser.</p>\n<p>The service workers lifecycle looks like this:</p>\n<ol>\n<li>download</li>\n<li>install</li>\n<li>activate</li>\n</ol>\n<p>The <code class=\"language-text\">install</code> and <code class=\"language-text\">activate</code> events will both be fired when a new service worker is registered for use. The difference between the two is that the <code class=\"language-text\">install</code> event can execute while another service worker is still in use.</p>\n<p>There can only be one activated version of a service worker at a time. A service worker that is ready to be replaced will remain activated as long as one page is using the service worker.</p>\n<p>So how should we use each? The <code class=\"language-text\">install</code> event is useful for setting up any initial data the service worker will need. An example usage of the <code class=\"language-text\">install</code> event could be to fetch and cache an <code class=\"language-text\">offline.html</code> file so that it is ready if the connection is lost. Because the <code class=\"language-text\">activate</code> event will only run when no other service workers are activated, we can safely use this method to clean up any cached data left over by a previous service worker.</p>\n<p>Responding to each looks a little something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'install'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle event</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'activate'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle event</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Handling Requests</h3>\n<p>After a service worker has been installed and activated it can begin processing web requests. In order to do so we want to listen to the <code class=\"language-text\">fetch</code> event. Handling requests is where the meat of our service worker will live.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle event</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>An empty event handler isn't too fun, so let's add something to it! Let's log all of the requests for a given web page.</p>\n<p><a href=\"https://glitch.com/~level-teller\">Demo</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// log request url</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logging!'</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Service workers also have the ability to respond to the requests.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this case, we use the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith\"><code class=\"language-text\">event.respondWith()</code></a> method which accepts a Promise to dictate how the service worker should respond to the request. The above example will simply use the <code class=\"language-text\">fetch</code> API to make the same request that the browser would have made if the service worker were not present.</p>\n<p>Great! Now that we're responding to requests, we can start to have a little more fun.</p>\n<h3>Caching Requests</h3>\n<p>The final exercise to review before we begin building a service worker is caching. If a webpage has some data or imagery that is needed by many pages it may be a good idea to cache these items so they are not downloaded in the future. Caching all requests will allow a site to be loaded offline.</p>\n<p>Service workers rely on the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage\"><code class=\"language-text\">CacheStorage</code></a> API for caching requests. The Chrome developer tools event have a special area for view the items in <code class=\"language-text\">CacheStore</code>.</p>\n<p><a href=\"https://glitch.com/~nickel-fold\">Demo</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-cache'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>cache <span class=\"token operator\">=></span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/17564d1df65be98f8b0c5bc7adae83c4/8d473/updated-cache.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 660px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 68.64988558352401%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACH0lEQVQ4y51Ty3LUMBD0R6SKpJat2Jbk9VqW/Pb6tU87sAkHiqI4ABdOHDjkyzlzVCMpyVYOIQQOXe0ZSePu0cgZpg5Dv1HrzRZ9v8aw3qDrB+z3Iw7jhHG6wjhe4e3x2uZ2uz2qaoWIx4gijqKoVNv1aNpOrZr2lzP0gyrLQi8UKMsS5tuyjtMkQZamiGMOHkXgPIKUEotFgPl8jtezGYIgMHnFOddrAs7+sEfbtsoUrKoKaZpBCGEPxiKG0JtMHGtFWZahqlco9A+Ni7KsUK9WynCja8gkUc44jtgfDlgPPeKsBssPOF/UmJMOHt3ggjR4RWqckQJnfg5XbhC31xDdDc6DGrOwxbJ+A94ccbFo4DRNgzzPLYw6meZgiyUI0VaYhGA6p5EEhY3DZQwuEsQyBWEL0CBEFEsbUxbC2W63GIZBX0hvrbnuJXzf0wV9eL5rQXwCRig4iRD4DK53Cc8zed/uNd8PsXM8HjFNE7qu031LwBh7EpRRrYhY/tMeA8eMhWlwlhfQTQXVSij9fzhFIlBIjjKJIfkSrrGrLfpa/gP/C5zdx2+obj6jfPcFop2w9EP45G7RM/2x/SQvhrP5eoviw3eUn35Abt8j8QVSlkJSiYhGCEl4p5aQEz9bsMqksawqazk8KQrM2FAOQYXlZ4qpR6ycflgrcyGFnnZzy7YX95ZdOzbeS9Spk8L7obZPzzy3pw7+xfJjhT9/A3u2pLqO2KrLAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    ></span>\n    <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;box-shadow:inset 0px 0px 0px 400px white;\"\n        alt=\"Updated cache\"\n        title=\"View of Cache Storage in Dev Tools\"\n        src=\"/static/17564d1df65be98f8b0c5bc7adae83c4/1dc1d/updated-cache.png\"\n        srcset=\"/static/17564d1df65be98f8b0c5bc7adae83c4/7d8cb/updated-cache.png 165w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/a2a24/updated-cache.png 330w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/1dc1d/updated-cache.png 660w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/3a2d0/updated-cache.png 990w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/4dfd0/updated-cache.png 1320w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/8d473/updated-cache.png 1748w\"\n        sizes=\"(max-width: 660px) 100vw, 660px\"\n      />\n  </span>\n  </a>\n    <figcaption class=\"gatsby-resp-image-figcaption\">View of Cache Storage in Dev Tools</figcaption>\n  </figure></p>\n<p>Now we are storing the requests in the cache!</p>\n<p>So we're adding data to the cache, but never using it. In order to do we'll have to call the <code class=\"language-text\">event.respondWith()</code> from the previous section. For now, lets update our service work to do the following things:</p>\n<ol>\n<li>If a request exists in the cache, respond with the cached response</li>\n<li>If the request is not in the cache, fetch and cache the response</li>\n</ol>\n<p><a href=\"https://glitch.com/~hungry-apartment\">Demo</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">findInCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>request<span class=\"token punctuation\">.</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> not in cache`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> response\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addToCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-cache'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>cache <span class=\"token operator\">=></span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> event <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">findInCache</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span>response <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">TypeError</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Bad response status'</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span>\n          <span class=\"token punctuation\">}</span>\n          <span class=\"token keyword\">return</span> <span class=\"token function\">addToCache</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>error <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Remember how I said a big part of writing service workers is managing Promises? Anyways, now we have a service worker that is actually doing something. Any uncached requests will be fetched and cached and any cached requests are pulled from the cache without ever making the request! This means that after loading the page, you should be able to turn off your WiFi, refresh, and still see the webpage. Without the service worker, you would have seen the \"This page is offline\" message from the browser.</p>\n<p>Note! This is not a good service worker to use in production because it will cache all requests - including the page itself - meaning that any changes published to the site will not be visible until the cache has expired.</p>\n<h2>Finishing Touches</h2>\n<p>Now that we have a service worker that caches requests we can start to think about improvements. There are many that come to mind, but here are the one's we'll be getting to in this post.</p>\n<ol>\n<li>Do not load HTML pages from cache unless offline</li>\n<li>Provide an offline page in the case a page has not been cached</li>\n<li>If showing an offline page, automatically refresh the page when connection is restored</li>\n</ol>","frontmatter":{"date":"March 05, 2019","path":"/blog/taking-a-site-offline-with-service-workers","title":"Taking a Site Offline with Service Workers 🤖","image":null}}},"pageContext":{}}