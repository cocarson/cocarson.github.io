{
    "componentChunkName": "component---src-templates-post-js",
    "path": "/blog/my-first-service-worker",
    "result": {"data":{"site":{"siteMetadata":{"title":"Carson Covell","url":"https://carsoncovell.com/","description":"Carson Covell is a web developer living in Atlanta, GA."}},"markdownRemark":{"html":"<h2>Introduction</h2>\n<p>Service workers have been floating around my space of the web for the past few years. Along with terms like \"Progressive Web Apps\" and other futuristic technologies I wasn't sure what to make of them. To be honest, I was always put off by the name. It is so jargony and technical that I figured it must be another front-end fad that was better to let pass.</p>\n<p>But of course, here I am several years later and they are still around. Service workers are being implemented all over the web; from sites trying to provide seamless offline experiences to mega blogs interested in bombarding you with desktop push notifications, service workers have become an integral part of the web experience.</p>\n<p>So what is a service worker? In its simplest form, a service worker is a JavaScript file that has access to a page's requests and the subsequent responses. For some reason, I figured a service worker had to be way more complex than that. But no, not really. Service workers are just scripts that intercept network requests with a few other nifty APIs added on top.</p>\n<p>What is the value in a script that intercepts page requests? One of the core motivations for service workers is to provide improved offline experiences. This is especially relevant for mobile devices (or my home WiFi network) where internet connection could be lost at any time.</p>\n<p>On a mobile app, if you lose connection the app doesn't crash and burn. Instead, it will often display a message about the connection loss if relevant and allow you to continue using the app with whatever data it has downloaded. When connection returns, the app automatically reconnects and immediately performs the relevant network requests. This is a huge shift from web apps that require the user to refresh the page, reloading the entire app from scratch.</p>\n<p>The allure of service workers is in their ability to give web apps the tools to perform similar functionality. This is especially impactful internationally where mobile data plans and storage may be limited and users do not want to download entire apps to their devices.</p>\n<h2>Writing a Service Worker</h2>\n<p>To start writing a service worker I recommend understanding event-based programming and Promises in JavaScript.</p>\n<p>Service workers respond to events - the FetchEvent, InstallEvent, NotificationEvent, and SyncEvent to name a few. I would definitely recommend understanding JavaScript event-based programming and callbacks before learning to write a service worker.</p>\n<p>While Promise logic is not always easy to follow, understanding the way they work is required in order to write a service worker. Service worker APIs rely heavily on Promises because they are intercepting requests, so it is important the code is non-blocking and asynchronous.</p>\n<p>All that is left to begin writing a service worker is learning the related APIs and how they fit together. This requires a bit of memorization off the bat, but luckily there is great <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API\">documentation</a> available for reference. (love you MDN ‚ù§Ô∏è)</p>\n<p>The service worker I wrote is relatively minimal. Its purpose is to allow a site to be loaded from CacheStorage when the user is offline.</p>\n<h3>Service Worker Lifecycle</h3>\n<p>Service worker files are loaded by the browser differently than normal HTML, CSS and JS files. Instead of being fetched and parsed on page load, service workers go through an install process, or \"activation lifecycle\". The service worker begins to work through its lifecycle when it is \"registered\" by a script on a page. After registration, the service work is cached by the browser until it is replaced by a new service worker.</p>\n<p>The service worker lifecycle looks like this:</p>\n<ol>\n<li>download</li>\n<li>install</li>\n<li>activate</li>\n</ol>\n<p>The <code class=\"language-text\">install</code> and <code class=\"language-text\">activate</code> events will both be fired when a new service worker is registered for use. The difference between the two is that the <code class=\"language-text\">install</code> event can execute while another service worker is still active.</p>\n<p>There can only be one activated version of a service worker at a time. An old service worker that is ready to be replaced will remain activated as long as one page in the user's browser is still using it.</p>\n<p>So how should we use each of these lifecycle events? The <code class=\"language-text\">install</code> event is useful for setting up any initial data the service worker will need. An example use of the <code class=\"language-text\">install</code> event could be to fetch and cache an <code class=\"language-text\">offline.html</code> file so that it is ready if the connection is lost. Because the <code class=\"language-text\">activate</code> event will only run when no other service workers are activated, we can safely use this method to clean up any cached data left over by a previous service worker.</p>\n<p>A webpage can register a service worker by calling the <code class=\"language-text\">navigator.serviceWorker.register()</code> method.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// script.js</span>\n\n<span class=\"token comment\">// first, check if the serviceWorker API is supported!</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token string\">'serviceWorker'</span> <span class=\"token keyword\">in</span> navigator<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// navigator.serviceWorker.register(pathToServiceWorker, options)</span>\n  navigator<span class=\"token punctuation\">.</span>serviceWorker<span class=\"token punctuation\">.</span><span class=\"token function\">register</span><span class=\"token punctuation\">(</span><span class=\"token string\">'sw.js'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> scope<span class=\"token operator\">:</span> <span class=\"token string\">'/'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Responding to each looks a little something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'install'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle event</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'activate'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle event</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Handling Requests</h3>\n<p>After a service worker has been installed and activated it can begin processing web requests. In order to do so, it will need to listen for the <code class=\"language-text\">fetch</code> event. Handling it fetch event is where the meat of this service worker will live.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// handle event</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>An empty event handler isn't too fun, time to add something to it! The below code will log all of the requests for a given web page. I've linked a Glitch project that can be used as a starting point if you want to follow along.</p>\n<p><a href=\"https://glitch.com/~level-teller\">Demo</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// log request url</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'logging!'</span><span class=\"token punctuation\">,</span> event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">.</span>url<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Service workers also have the ability to respond to the requests. Below is a service worker that accomplishes absolutely nothing. üôÉ</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span><span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In this case, the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/FetchEvent/respondWith\"><code class=\"language-text\">event.respondWith()</code></a> method is used to respond to the request. The method accepts a Promise to dictate how the service worker should respond to the request. The above example will use the <code class=\"language-text\">fetch</code> API to make the same request that the browser would have made if the service worker were not present.</p>\n<p>Great! Now that the service worker responds to requests, things can start to get a little more interesting.</p>\n<h3>Caching Requests</h3>\n<p>If a webpage has some data or imagery that is needed by many pages it may be a good idea to cache these items so they are not downloaded in the future. Caching the HTML page and its assets will allow a page to be loaded offline.</p>\n<p>Service workers rely on the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/CacheStorage\"><code class=\"language-text\">CacheStorage</code></a> API for caching requests. The Chrome developer tools even have a special area for viewing the items in \"Cache Store\".</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 660px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/17564d1df65be98f8b0c5bc7adae83c4/7ef4c/updated-cache.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 68.48484848484848%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAOCAYAAAAvxDzwAAAACXBIWXMAABYlAAAWJQFJUiTwAAACI0lEQVQ4y42T3W7UMBCF8w4gpKoVbfyzaew4TmInm//dkF2JFQJBxR0SQqq448V5hN7kIHvZlkql6sWn8YyTkzkTOxh3LZqmX8Zxg6Zp0fcD6qbFuNlis9limma/3u322GwnDMOIdd2A8wh8FUEmCnXdLFW1RrWu74Jx2CzWWhRFAWMMSmthTOFjpjXyLINKEsTxNYQQSFMFEccgJMTl5VusVitIKZAkclFKIZjnGX3fL1VVwdoSOjcQUkGqFCJREElyjFJBpRnKqkFhSjT9CGMr2Kp2cVm3PXRWLF5wu91iHAfo3CKyM85FizOyBuMTzmmHM1rjNTV4RQq/J+r3UN0HXIgWb1iJyO4gmwMuRIegbVtv15HlOZRKcX0dg1KKmMdQPEXKNfJVAc01RCQRCwEpE2+XcY44FpCJyyME0zRhHEdPlmUIw9DjBEMS4opcgRACSggiGnnC8Mo/4+qO0ztuHRwOB+z3e3RdhzzP/Vc55/es+EPOOPP8W3vgWAvezTO6fkBhjLfMGffdPQWjzPO/fUdQZgomFbBaIlcCIX2wQgn1nPKXEMzffqH8fIvy5ifS+cb/BEbo/QwdXvyZrh51OHy9hf34HfbTD+j5CxRLkTENzTQSlkAy6W2+VDSoTQ6TyuVkmdBjV/7Y0NgLKqZ8/ozo8ndvCYZhXIyxMO6q5flx6G5ulDyyfBJ7SvQk5mfojkpRFIu7x+4cPtfJCzr8/Qc/2KSoxXuqIwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Updated cache\"\n        title=\"View of Cache Storage in Dev Tools\"\n        src=\"/static/17564d1df65be98f8b0c5bc7adae83c4/1f083/updated-cache.png\"\n        srcset=\"/static/17564d1df65be98f8b0c5bc7adae83c4/04c57/updated-cache.png 165w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/d9ecf/updated-cache.png 330w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/1f083/updated-cache.png 660w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/7a3d6/updated-cache.png 990w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/78958/updated-cache.png 1320w,\n/static/17564d1df65be98f8b0c5bc7adae83c4/7ef4c/updated-cache.png 1748w\"\n        sizes=\"(max-width: 660px) 100vw, 660px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">View of Cache Storage in Dev Tools</figcaption>\n  </figure></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-cache'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span> <span class=\"token operator\">=></span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span>event<span class=\"token punctuation\">.</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Note! <code class=\"language-text\">cache.add(request)</code> is shortcut for <code class=\"language-text\">cache.put(request, response)</code>.</p>\n<p>Woohoo! Now the service worker is storing responses to requests in the cache!</p>\n<p>So the data is being added to the cache, but never used afterward. In order to do that the service worker will have to call the <code class=\"language-text\">event.respondWith()</code> from the previous section. Time to update the service work with the following behavior:</p>\n<ol>\n<li>If a request exists in the cache, respond with the cached response</li>\n<li>If the request is not in the cache, fetch and cache the response</li>\n</ol>\n<p><a href=\"https://glitch.com/~hungry-apartment\">Demo</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">findInCache</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> caches<span class=\"token punctuation\">.</span><span class=\"token function\">match</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>response<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>request<span class=\"token punctuation\">.</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> not in cache</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> response\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">addToCache</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">request<span class=\"token punctuation\">,</span> response</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>response<span class=\"token punctuation\">.</span>ok<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> responseCopy <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span><span class=\"token function\">clone</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    caches<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my-cache'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">cache</span> <span class=\"token operator\">=></span> cache<span class=\"token punctuation\">.</span><span class=\"token function\">put</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> responseCopy<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> response\n<span class=\"token punctuation\">}</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> request <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> event\n  event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>\n    <span class=\"token function\">findInCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token function\">addToCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Note! In <code class=\"language-text\">addToCache()</code> the <code class=\"language-text\">responseCopy</code> is created because a response can only be read once. If we read the value into the cache, then it will not be available to pass back to <code class=\"language-text\">event.respondWith()</code>.</p>\n<p>Remember how I said a big part of writing service workers is managing Promises? More to come.</p>\n<p>Anyways, now the service worker is actually doing something. Here's where the code stands:</p>\n<ul>\n<li>Any uncached requests will be fetched and cached.</li>\n<li>Requests that have already been cached are pulled from the cache without ever making the request.</li>\n</ul>\n<p>This means that after loading the page, we should be able to turn off our WiFi, refresh, and still see the webpage. Without the service worker, we would have seen the \"This page is offline\" message from the browser.</p>\n<h3>Finishing Touches</h3>\n<p>This is great, but caching everything on the first load will prevent the site from updating when changes are published. Because the names of HTML files rarely change, we don't want to read these files from the cache unless absolutely necessary. Other files, like scripts and images, are less likely to have file contents change under the same file name so it makes sense to read them from the cache. Also, they tend to have larger file sizes so caching them is more valuable.</p>\n<p>The new logic flow should be:</p>\n<ul>\n<li>If online\n<ul>\n<li>Fetch the requested page</li>\n<li>Update the cache with the response</li>\n</ul>\n</li>\n<li>If offline\n<ul>\n<li>Return the last cached page</li>\n<li>If the cache is empty then display an offline message</li>\n</ul>\n</li>\n</ul>\n<p>In order to detect if a request is for a page, we can check the request mode on the <code class=\"language-text\">FetchEvent</code>.</p>\n<p><a href=\"https://glitch.com/~hungry-tilapia\">Final Demo</a></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">// sw.js</span>\n\n<span class=\"token comment\">// ... addToCache and findInCache methods</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">offlineResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Response</span><span class=\"token punctuation\">(</span>\n    <span class=\"token string\">'&lt;h1 styling=\"padding: 20px\">Uh, oh! Looks like you are offline :(&lt;/h1>'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>\n      headers<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">'Content-Type'</span><span class=\"token operator\">:</span> <span class=\"token string\">'text/html'</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\nself<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetch'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">event</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> request <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> event\n\n  <span class=\"token comment\">// if requesting a page load</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>mode <span class=\"token operator\">===</span> <span class=\"token string\">'navigate'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n        <span class=\"token comment\">// online -> fetch a fresh copy and update cache</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token function\">addToCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// offline -> find in cache</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">findInCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// not in cache -> display offline message</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">offlineResponse</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    event<span class=\"token punctuation\">.</span><span class=\"token function\">respondWith</span><span class=\"token punctuation\">(</span>\n      <span class=\"token function\">findInCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span> <span class=\"token operator\">=></span> <span class=\"token function\">addToCache</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>With this change, pages should always fetch the most up-to-date version when online and all other assets will be loaded from the cache when available.</p>\n<p>You can play around with this in the <a href=\"https://glitch.com/~hungry-tilapia\">Demo</a>.</p>\n<p>First, make sure that the Cache Storage is empty. Then, load the home page and view the contents of the cache. You should see that <code class=\"language-text\">/</code>, <code class=\"language-text\">/script.js</code> and <code class=\"language-text\">/style.css</code> have been added to the cache. Next, click the \"Offline\" checkbox under the \"Service Workers\" menu item.</p>\n<p>Next, click the link on the page for 'Page 2'. Refresh the page and the offline message will display because Page 2 has not been added into the cache. Lastly, return to the home page and refresh. It loads even though the site is offline. Wonderful!</p>\n<h2>Conclusion</h2>\n<p>This is really just a taste of what service workers can do. In this exercise, we were able to cache a site for offline browsing with a relatively small amount of code. Now, this is absolutely not a Production Ready‚Ñ¢ service worker, but I think it provides a solid starting point to continue learning about service workers.</p>\n<p>Besides the caching functionality used above, service workers have a few other notable features. Everyone's favorite <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Notifications_API\">push notifications</a> allow web applications to send notifications to a device, the <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Channel_Messaging_API\">Channel Messaging API</a> allows a service worker to send messages to the JS files on the site/app that it is in context with, and the futuristic Background Sync API (not standardized) will allow the service worker to queue up actions to perform once a user's internet connection is returned. All of these have the ability to improve user experience on the web.</p>\n<p>By working through this exercise I learned that service workers are relatively simple to write, but perhaps the strategy around writing one well is the tricky part. I'm looking forward to continuing to experiment and learn about service workers.</p>\n<p>If you have a question or noticed a problem with any part of this post, please reach out through any social network a let me know.</p>\n<p>Happy coding ü§ì</p>\n<p>Further Reading:</p>\n<ul>\n<li><a href=\"https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API\">Service Worker API (MDN)</a></li>\n<li><a href=\"https://developers.google.com/web/ilt/pwa/introduction-to-service-worker\">Introduction to Service Worker (Google)</a></li>\n<li><a href=\"https://www.smashingmagazine.com/2018/09/smashing-book-6-release/\">Smashing Book 6: Building An Advanced Service Worker</a></li>\n</ul>","frontmatter":{"date":"March 25, 2019","path":"/blog/my-first-service-worker","title":"My First Service Worker ü§ñ","image":null}}},"pageContext":{}},
    "staticQueryHashes": []}